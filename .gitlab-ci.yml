default:
  tags:
    - ocf-core

# ============================================================================
# Variables
# ============================================================================

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================================================
# Stages
# ============================================================================

stages:
  - test     # Used in release component
  - check    # Version validation and auto-tagging
  - build    # Docker image creation on release tags
  - release  # Release creation

# ============================================================================
# Cache Configuration
# ============================================================================

.npm_cache:
  cache:
    key: "${CI_COMMIT_REF_SLUG}-npm"
    paths:
      - node_modules/
      - .npm/

# ============================================================================
# Release Component
# ============================================================================

include:
  - component: usine.solution-libre.fr/gitlab/components/release/default@0.2.1
    inputs:
      # Enable all new features
      enable_version_check: true
      enable_docker_build: true
      enable_enhanced_release_notes: true

      # Configure stages to match our pipeline
      check_stage: check
      build_stage: build
      stage: release

      # Version management
      version_file: "VERSION"
      main_branch: "main"
      tag_prefix: "v"

      # Docker build
      dockerfile_path: "Dockerfile"
      build_context: "."

      # Disable old changelog component (using enhanced notes instead)
      disable_changelog: true
